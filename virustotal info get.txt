import pandas as pd
import requests
import datetime

def get_malware_info(sha256):
    api_key = '9a13ec6259c33eefb319b263f9cc6743f511c57de08cfafd0adffb0497c0aba2'  # Replace with your actual VirusTotal API key
    url = f'https://www.virustotal.com/api/v3/files/{sha256}'
    headers = {'x-apikey': api_key}
    response = requests.get(url, headers=headers)
    print(response)
    
    if response.status_code == 200:
        json_response = response.json()
        if 'data' in json_response:
            attributes = json_response['data']['attributes']
            if 'popular_threat_classification' in attributes:
                print(attributes['popular_threat_classification'])
                name = attributes['popular_threat_classification']['suggested_threat_label']
                if 'popular_threat_category' in attributes['popular_threat_classification']:
                    category = attributes['popular_threat_classification']['popular_threat_category'][0]['value']
                else:
                    category = None
                if 'popular_threat_name' in attributes['popular_threat_classification']:
                    family = attributes['popular_threat_classification']['popular_threat_name'][0]['value']
                else:
                    family = None
                date = datetime.datetime.utcfromtimestamp(attributes['first_submission_date'])
                first_date = date.strftime("%Y-%m-%d %H:%M:%S")  # Format as "YYYY-MM-DD HH:MM:SS"

                print(first_date)
                return name, category, family, first_date   
    return None, None, None, None

data = pd.read_excel('Dataset.xlsx')
data[['Malware Name', 'Category', 'AV Class Label', 'First Submission Date']] = data['sha1'].apply(get_malware_info).apply(pd.Series)
data.to_excel('Dataset.xlsx', index=False)
