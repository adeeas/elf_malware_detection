import os, time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys

driver = webdriver.Firefox()
driver.get("http://127.0.0.1:4242")

download_directory = "/home/reports"

table_data = []

while True:
    # Locate the table element
    time.sleep(2)
    table = driver.find_element(By.CSS_SELECTOR, ".ant-table-body > table:nth-child(1)")
    rows = table.find_elements(By.XPATH, ".//tr")
   
    for index, row in enumerate(rows):
        if index == 0:
            continue
        columns = row.find_elements(By.XPATH, ".//td")  
        row_data = [column.text for column in columns]
        task_id = str(row_data[:1])
        task_id = task_id[2:-2]
        open_analysis_link = "http://127.0.0.1:4242/result/" + task_id
        script = f"window.open('{open_analysis_link}', '_blank');"
        driver.execute_script(script)
        current_url = driver.current_url
        print("Current URL:", current_url)
        driver.switch_to.window(driver.window_handles[-1])
        current_url = driver.current_url
        print("Current URL:", current_url)
        time.sleep(3)
        download_button = driver.find_element(By.CSS_SELECTOR, "button:nth-child(1)")
        driver.execute_script("arguments[0].click();", download_button)
       # driver.switch_to.window(driver.window_handles[-2])
        if driver.current_url == "about:blank":
            driver.close()
        if driver.current_url == open_analysis_link:
            driver.close()
        driver.switch_to.window(driver.window_handles[0])
        
    next_link = driver.find_element(By.CSS_SELECTOR, ".ant-pagination-next > a:nth-child(1)")
    color = next_link.value_of_css_property("color")
    print(color)
    if color != "rgba(0, 0, 0, 0.65)":
        break
    driver.execute_script("arguments[0].click();", next_link)


#driver.quit()